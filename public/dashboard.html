// FIXED AI Prompt Endpoint
app.put('/api/ai-prompt', authenticateToken, async (req, res) => {
    try {
        const { prompt } = req.body;
        
        console.log('📝 Received AI prompt save request:', {
            userId: req.user.id,
            promptLength: prompt?.length
        });
        
        // Add proper validation
        if (!prompt || typeof prompt !== 'string') {
            console.error('❌ Invalid prompt data:', { prompt });
            return res.status(400).json({ 
                success: false, 
                error: 'طلب غير صالح - البيانات مفقودة' 
            });
        }
        
        if (prompt.trim().length === 0) {
            return res.status(400).json({ 
                success: false, 
                error: 'النص لا يمكن أن يكون فارغاً' 
            });
        }
        
        // Check if user is admin
        if (req.user.role !== 'admin') {
            return res.status(403).json({ 
                success: false, 
                error: 'غير مصرح - تحتاج صلاحيات المدير' 
            });
        }
        
        // Save to database or file system
        // Example: Save to a file
        const fs = require('fs').promises;
        const aiPromptPath = './data/ai-prompts/system-prompt.txt';
        
        try {
            // Ensure directory exists
            await fs.mkdir('./data/ai-prompts', { recursive: true });
            
            // Save the prompt
            await fs.writeFile(aiPromptPath, prompt, 'utf8');
            
            console.log('✅ AI prompt saved successfully');
            
            res.json({ 
                success: true, 
                message: 'تم حفظ نظام الذكاء الاصطناعي بنجاح' 
            });
            
        } catch (fileError) {
            console.error('❌ File system error:', fileError);
            res.status(500).json({ 
                success: false, 
                error: 'فشل حفظ النظام في الملف' 
            });
        }
        
    } catch (error) {
        console.error('❌ Error saving AI prompt:', error);
        res.status(500).json({ 
            success: false, 
            error: 'فشل حفظ النظام' 
        });
    }
});

// GET AI Prompt Endpoint
app.get('/api/ai-prompt', authenticateToken, async (req, res) => {
    try {
        // Check if user is admin
        if (req.user.role !== 'admin') {
            return res.status(403).json({ 
                success: false, 
                error: 'غير مصرح - تحتاج صلاحيات المدير' 
            });
        }
        
        // Read from file system
        const fs = require('fs').promises;
        const aiPromptPath = './data/ai-prompts/system-prompt.txt';
        
        try {
            const prompt = await fs.readFile(aiPromptPath, 'utf8');
            
            res.json({ 
                success: true, 
                prompt: prompt 
            });
            
        } catch (fileError) {
            if (fileError.code === 'ENOENT') {
                // File doesn't exist, return empty prompt
                res.json({ 
                    success: true, 
                    prompt: '' 
                });
            } else {
                throw fileError;
            }
        }
        
    } catch (error) {
        console.error('❌ Error loading AI prompt:', error);
        res.status(500).json({ 
            success: false, 
            error: 'فشل تحميل النظام' 
        });
    }
});
