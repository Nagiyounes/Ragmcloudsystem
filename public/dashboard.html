<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ù‚Ù… ÙƒÙ„Ø§ÙˆØ¯ ERP - Smart Sales Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007C5C',
                        'primary-dark': '#006A4E',
                        'primary-light': '#00B98B',
                        luxury: {
                            gold: '#D4AF37',
                            'dark-bg': '#1a1f2e',
                            'card-bg': '#2d3748',
                            'sidebar-bg': '#2d3748'
                        }
                    },
                    fontFamily: {
                        'tajawal': ['Tajawal', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .luxury-card {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .gold-border {
            border: 2px solid #D4AF37;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-gold {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            color: #1a1f2e;
            transition: all 0.3s ease;
        }
        
        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
        }
        
        .status-connected {
            background: linear-gradient(135deg, #00B98B, #007C5C);
            color: white;
        }
        
        .status-disconnected {
            background: linear-gradient(135deg, #f56565, #c53030);
            color: white;
        }
        
        .client-item {
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .client-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .client-item.active {
            background: rgba(0, 124, 92, 0.2);
            border-right: 3px solid #00B98B;
        }
        
        .unread-badge {
            background: linear-gradient(135deg, #f56565, #c53030);
            color: white;
        }
        
        /* IMPROVED CHAT STYLES */
        .chat-container {
            height: calc(100vh - 280px);
            overflow-y: auto;
            scroll-behavior: smooth;
            padding: 10px;
        }
        
        .chat-bubble {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 6px;
            position: relative;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .chat-bubble.sent {
            background: linear-gradient(135deg, #007C5C, #00B98B);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-bubble.received {
            background: rgba(255, 255, 255, 0.1);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-content {
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .chat-time {
            text-align: left;
            direction: ltr;
            font-size: 11px;
            opacity: 0.7;
            margin-top: 2px;
        }
        
        .scroll-to-bottom {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 124, 92, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 100;
        }
        
        .scroll-to-bottom.visible {
            opacity: 1;
        }
        
        .scroll-to-bottom:hover {
            background: rgba(0, 124, 92, 1);
            transform: scale(1.1);
        }
        
        /* Client Interest Status Colors */
        .client-status-interested {
            border-left: 4px solid #10B981 !important;
        }
        
        .client-status-busy {
            border-left: 4px solid #F59E0B !important;
        }
        
        .client-status-not-interested {
            border-left: 4px solid #EF4444 !important;
        }
        
        .client-status-no-reply {
            border-left: 4px solid #9CA3AF !important;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }
        
        .dot-interested { background-color: #10B981; }
        .dot-busy { background-color: #F59E0B; }
        .dot-not-interested { background-color: #EF4444; }
        .dot-no-reply { background-color: #9CA3AF; }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #00B98B, #007C5C);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #f56565, #c53030);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }
        
        .qr-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .qr-container {
            background: rgba(45, 55, 72, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #D4AF37;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #FFD700, #D4AF37);
        }
        
        /* Client Status Filter */
        .status-filter {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .status-filter-btn {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .status-filter-btn.active {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .btn-all { background: #6B7280; color: white; }
        .btn-interested { background: #10B981; color: white; }
        .btn-busy { background: #F59E0B; color: white; }
        .btn-not-interested { background: #EF4444; color: white; }
        .btn-no-reply { background: #9CA3AF; color: white; }

        /* NEW: Auto-report notification */
        .auto-report-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            padding: 15px;
            border-radius: 10px;
            animation: pulse 2s infinite;
            display: none;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* NEW: Bot status indicator */
        .bot-status-stopped {
            background: linear-gradient(135deg, #f56565, #c53030) !important;
        }

        .bot-status-running {
            background: linear-gradient(135deg, #00B98B, #007C5C) !important;
        }

        /* NEW: User Management Styles */
        .user-management-section {
            transition: all 0.3s ease;
        }

        .user-item {
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .role-admin {
            border-left: 4px solid #D4AF37 !important;
        }

        .role-standard {
            border-left: 4px solid #007C5C !important;
        }

        .user-active {
            color: #10B981;
        }

        .user-inactive {
            color: #EF4444;
        }

        /* NEW: User Switch Overlay */
        .user-switch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .user-switch-container {
            background: rgba(45, 55, 72, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #D4AF37;
            max-width: 500px;
            width: 90%;
        }

        /* NEW: WhatsApp QR Code Status */
        .whatsapp-qr-status {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .whatsapp-qr-status:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(237, 137, 54, 0.3);
        }

        /* NEW: Logout Button Styles */
        .logout-btn {
            background: linear-gradient(135deg, #f56565, #c53030);
            color: white;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(245, 101, 101, 0.4);
        }
    </style>
</head>
<body class="text-white">
    <div id="toastContainer" class="fixed top-4 right-4 z-50"></div>
    
    <div id="autoReportNotification" class="auto-report-notification">
        <i class="fas fa-bell mr-2"></i>
        <span id="autoReportMessage"></span>
    </div>
    
    <div id="userSwitchOverlay" class="user-switch-overlay hidden">
        <div class="user-switch-container">
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-user-shield text-3xl text-primary-light mr-3"></i>
                <h3 class="text-xl font-bold gradient-text">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
            </div>
            <p class="text-gray-300 mb-4">Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ´Ø§Ù‡Ø¯ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙƒÙ€: <span id="currentViewingUser" class="text-primary-light"></span></p>
            <div class="flex space-x-3 justify-center">
                <button id="returnToAdmin" class="btn-gold px-6 py-2 rounded-lg font-bold">
                    <i class="fas fa-arrow-left mr-2"></i>Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ÙŠ
                </button>
                <button id="closeUserSwitch" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-bold transition-colors">
                    <i class="fas fa-times mr-2"></i>Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>
    
    <div id="qrOverlay" class="qr-overlay hidden">
        <div class="qr-container luxury-card">
            <div class="flex items-center justify-center mb-4">
                <i class="fab fa-whatsapp text-3xl text-green-400 mr-3"></i>
                <h3 class="text-xl font-bold gradient-text">Ù…Ø³Ø­ Ø±Ù…Ø² QR</h3>
            </div>
            <p class="text-gray-300 mb-4">Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ù‡Ø°Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø§ØªØµØ§Ù„</p>
            <div id="qrCode" class="mb-4 flex justify-center"></div>
            <p id="qrStatusMessage" class="text-red-400 mb-4 text-sm hidden">Ø¬Ø§Ø±Ù Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...</p>
            <button id="closeQR" class="btn-gold px-6 py-2 rounded-lg font-bold">
                <i class="fas fa-times mr-2"></i>Ø¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    </div>
    
    <div class="flex h-screen">
        <div class="w-80 luxury-card rounded-r-2xl m-3 flex flex-col">
            <div class="p-6 border-b border-gray-600">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-primary-light flex items-center justify-center text-white mr-3">
                            <i class="fas fa-cloud"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold gradient-text">Ø±Ù‚Ù… ÙƒÙ„Ø§ÙˆØ¯</h1>
                            <p class="text-sm text-gray-400">ERP Sales Assistant</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-300">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
                    <span id="currentUserName" class="px-3 py-1 bg-primary rounded-full text-sm font-bold">...</span>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-300">Ø§Ù„Ø¯ÙˆØ±:</span>
                    <span id="currentUserRole" class="px-3 py-1 bg-purple-600 rounded-full text-sm font-bold">...</span>
                </div>
                 <div id="viewingAsBadge" class="flex items-center justify-center bg-gray-700 p-2 rounded-lg mb-2 hidden">
                    <i class="fas fa-eye text-yellow-400 ml-2"></i>
                    <span class="text-xs text-yellow-400">ØªØ´Ø§Ù‡Ø¯ ÙƒÙ€: <span id="viewingAsName"></span> (<span id="viewingAsRole"></span>)</span>
                </div>
                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm text-gray-300">Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</span>
                    <span id="whatsappStatus" class="status-disconnected px-3 py-1 rounded-full text-sm font-bold">ØºÙŠØ± Ù…ØªØµÙ„</span>
                </div>
                
                <div class="flex space-x-2 mb-4 justify-between" dir="ltr">
                    <button id="reconnectBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-1"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                    </button>
                    <button id="stopBotBtn" class="bot-status-running text-white text-sm px-3 py-1 rounded-lg transition-colors">
                        <i class="fas fa-stop mr-1"></i>Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª
                    </button>
                    <button id="userSwitchBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white text-sm px-3 py-1 rounded-lg transition-colors hidden">
                        <i class="fas fa-users mr-1"></i>ØªØ¨Ø¯ÙŠÙ„
                    </button>
                </div>
                <div id="whatsappQrStatus" class="whatsapp-qr-status hidden">
                    <i class="fas fa-qrcode mr-2"></i>
                    <span>Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ QR Code</span>
                </div>
            </div>
            
            <div id="userManagementSection" class="p-6 border-b border-gray-600 hidden user-management-section">
                <h3 class="font-bold text-lg mb-3 gradient-text"><i class="fas fa-user-shield mr-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                <div class="mb-4 bg-gray-700 p-3 rounded-lg">
                    <h4 class="font-bold text-primary-light mb-2">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
                    <input type="text" id="newUserName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm mb-2 focus:outline-none focus:border-primary">
                    <input type="text" id="newUserUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm mb-2 focus:outline-none focus:border-primary">
                    <input type="password" id="newUserPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm mb-2 focus:outline-none focus:border-primary">
                    <select id="newUserRole" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm mb-2 focus:outline-none focus:border-primary">
                        <option value="standard">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
                        <option value="admin">Ù…Ø¯ÙŠØ±</option>
                    </select>
                    <button id="addUserBtn" class="w-full bg-primary hover:bg-primary-dark py-2 rounded-lg font-bold transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
                    </button>
                </div>
                <div class="max-h-40 overflow-y-auto">
                    <h4 class="font-bold text-primary-light mb-2">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h4>
                    <div id="usersList">
                        </div>
                </div>
            </div>

            <div class="p-6 overflow-y-auto flex-grow">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-lg gradient-text">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (<span id="clientsListCount">0</span>)</h3>
                    <button id="uploadBtn" class="bg-primary hover:bg-primary-dark text-white text-sm px-3 py-1 rounded-lg transition-colors">
                        <i class="fas fa-file-upload mr-1"></i>Ø±ÙØ¹ Excel
                    </button>
                </div>
                <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden">
                <p id="fileInfo" class="text-xs text-gray-400 mb-3 hidden"></p>
                
                <div class="status-filter">
                    <button class="status-filter-btn btn-all active" data-status="all">Ø§Ù„ÙƒÙ„</button>
                    <button class="status-filter-btn btn-no-reply" data-status="no-reply">Ù„Ù… ÙŠØ±Ø¯</button>
                    <button class="status-filter-btn btn-interested" data-status="interested">Ù…Ù‡ØªÙ…</button>
                    <button class="status-filter-btn btn-busy" data-status="busy">Ù…Ø´ØºÙˆÙ„</button>
                    <button class="status-filter-btn btn-not-interested" data-status="not-interested">ØºÙŠØ± Ù…Ù‡ØªÙ…</button>
                </div>

                <div id="clientList" class="space-y-1">
                    </div>
            </div>
            
            <div class="p-6 border-t border-gray-600">
                <button id="logoutBtn" class="w-full logout-btn py-2 rounded-lg font-bold transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>

        <div class="flex-grow flex flex-col m-3 luxury-card rounded-2xl">
            
            <div class="p-6 border-b border-gray-600">
                <h3 class="font-bold text-xl gradient-text mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                <div class="grid grid-cols-4 gap-4 text-center">
                    <div class="luxury-card p-3 rounded-lg">
                        <div id="statMessages" class="text-2xl font-bold text-primary-light">0</div>
                        <div class="text-xs text-gray-400">Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø³Ù„Ø©</div>
                    </div>
                    <div class="luxury-card p-3 rounded-lg">
                        <div id="statAIReplies" class="text-2xl font-bold text-primary-light">0</div>
                        <div class="text-xs text-gray-400">Ø±Ø¯ÙˆØ¯ AI</div>
                    </div>
                    <div class="luxury-card p-3 rounded-lg">
                        <div id="statClients" class="text-2xl font-bold text-primary-light">0</div>
                        <div class="text-xs text-gray-400">Ø¹Ù…Ù„Ø§Ø¡ Ù…ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡Ù…</div>
                    </div>
                    <div class="luxury-card p-3 rounded-lg">
                        <div id="statInterested" class="text-2xl font-bold text-primary-light">0</div>
                        <div class="text-xs text-gray-400">Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù‡ØªÙ…ÙŠÙ†</div>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button id="exportReportBtn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm px-3 py-1 rounded-lg transition-colors">
                        <i class="fas fa-file-export mr-1"></i>ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                    <button id="sendReportBtn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm px-3 py-1 rounded-lg transition-colors">
                        <i class="fas fa-paper-plane mr-1"></i>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                </div>
            </div>

            <div class="flex flex-grow overflow-hidden">
                <div class="w-2/3 flex flex-col border-l border-gray-600">
                    <div id="chatHeader" class="p-4 border-b border-gray-600 flex items-center justify-between hidden">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-primary-light flex items-center justify-center text-white mr-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h2 id="currentClientName" class="text-lg font-bold"></h2>
                                <p id="currentClientPhone" class="text-sm text-gray-400"></p>
                            </div>
                        </div>
                        <div id="clientStatusSelector" class="hidden">
                             <select id="statusSelect" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-sm focus:outline-none focus:border-primary">
                                <option value="no-reply">Ù„Ù… ÙŠØ±Ø¯</option>
                                <option value="interested">Ù…Ù‡ØªÙ…</option>
                                <option value="busy">Ù…Ø´ØºÙˆÙ„</option>
                                <option value="not-interested">ØºÙŠØ± Ù…Ù‡ØªÙ…</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="chatContainer" class="chat-container flex-grow relative">
                        <div id="chatEmptyState" class="text-center text-gray-400 mt-20">
                            <i class="fas fa-comments text-7xl mb-4 opacity-50"></i>
                            <p class="text-lg text-gray-500">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                        </div>
                        <button id="scrollToBottom" class="scroll-to-bottom">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>

                    <div id="messageInputArea" class="p-4 border-t border-gray-600 hidden">
                        <div class="flex items-center">
                            <textarea id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-3 text-sm resize-none h-12 focus:outline-none focus:border-primary ml-2"></textarea>
                            <button id="sendMessageBtn" class="bg-primary hover:bg-primary-dark text-white p-3 rounded-full transition-colors h-12 w-12 flex items-center justify-center">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="w-1/3 p-4 flex flex-col space-y-4">
                    <h3 class="font-bold text-lg gradient-text border-b border-gray-700 pb-2">Ø­Ù…Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h3>
                    
                    <textarea id="bulkMessage" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© (Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)..." class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-sm h-32 resize-none focus:outline-none focus:border-primary"></textarea>
                    
                    <div class="flex items-center space-x-2" dir="ltr">
                        <label for="sendDelay" class="text-sm text-gray-400 whitespace-nowrap">ØªØ£Ø®ÙŠØ± (Ø«Ø§Ù†ÙŠØ©):</label>
                        <input type="number" id="sendDelay" value="5" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-sm focus:outline-none focus:border-primary text-center">
                    </div>
                    
                    <div id="bulkProgressInfo" class="text-sm text-gray-400 hidden">
                        <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="bulkTotal">0</span> | ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: <span id="bulkSent">0</span> | ÙØ´Ù„: <span id="bulkFailed">0</span></p>
                    </div>
                    
                    <button id="sendBulkBtn" class="bg-yellow-600 hover:bg-yellow-700 py-2 rounded-lg font-bold transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
                    </button>
                    <button id="retryBulkBtn" class="bg-red-600 hover:bg-red-700 py-2 rounded-lg font-bold transition-colors hidden">
                        <i class="fas fa-redo mr-2"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </button>
                    
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // ğŸ› ï¸ FRONTEND LOGIC - INITIALIZATION & VARIABLES
        // =============================================
        let socket;
        let authToken = localStorage.getItem('token');
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        let isAdminViewingAs = false; 
        let viewingAsUser = null;     
        let clients = [];
        let users = []; 
        let messages = {}; 
        let currentClient = null;
        let statusFilter = 'all';
        let isBotStopped = false; 
        let performanceStats = {}; 
        let bulkCampaignLog = []; // Log for bulk campaign failure retries
        const clientStatuses = {
            'no-reply': 'Ù„Ù… ÙŠØ±Ø¯',
            'interested': 'Ù…Ù‡ØªÙ…',
            'busy': 'Ù…Ø´ØºÙˆÙ„',
            'not-interested': 'ØºÙŠØ± Ù…Ù‡ØªÙ…',
            'all': 'Ø§Ù„ÙƒÙ„'
        };

        // DOM Elements
        const currentUserName = document.getElementById('currentUserName');
        const currentUserRole = document.getElementById('currentUserRole');
        const whatsappStatus = document.getElementById('whatsappStatus');
        const botStatus = document.getElementById('botStatus');
        const stopBotBtn = document.getElementById('stopBotBtn');
        const reconnectBtn = document.getElementById('reconnectBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userManagementSection = document.getElementById('userManagementSection');
        const userSwitchBtn = document.getElementById('userSwitchBtn');
        const userSwitchOverlay = document.getElementById('userSwitchOverlay');
        const currentViewingUser = document.getElementById('currentViewingUser');
        const returnToAdmin = document.getElementById('returnToAdmin');
        const closeUserSwitch = document.getElementById('closeUserSwitch');
        const usersList = document.getElementById('usersList');
        const newUserName = document.getElementById('newUserName');
        const newUserUsername = document.getElementById('newUserUsername');
        const newUserPassword = document.getElementById('newUserPassword');
        const newUserRole = document.getElementById('newUserRole');
        const addUserBtn = document.getElementById('addUserBtn');
        const statMessages = document.getElementById('statMessages');
        const statAIReplies = document.getElementById('statAIReplies');
        const statClients = document.getElementById('statClients');
        const statInterested = document.getElementById('statInterested');
        const uploadBtn = document.getElementById('uploadBtn');
        const excelFile = document.getElementById('excelFile');
        const fileInfo = document.getElementById('fileInfo');
        const bulkMessage = document.getElementById('bulkMessage');
        const sendDelay = document.getElementById('sendDelay');
        const sendBulkBtn = document.getElementById('sendBulkBtn');
        const retryBulkBtn = document.getElementById('retryBulkBtn');
        const bulkProgressInfo = document.getElementById('bulkProgressInfo');
        const bulkTotal = document.getElementById('bulkTotal');
        const bulkSent = document.getElementById('bulkSent');
        const bulkFailed = document.getElementById('bulkFailed');
        const clientList = document.getElementById('clientList');
        const clientsListCount = document.getElementById('clientsListCount');
        const exportReportBtn = document.getElementById('exportReportBtn');
        const sendReportBtn = document.getElementById('sendReportBtn');
        const currentClientName = document.getElementById('currentClientName');
        const currentClientPhone = document.getElementById('currentClientPhone');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const messageInputArea = document.getElementById('messageInputArea');
        const toastContainer = document.getElementById('toastContainer');
        const scrollToBottom = document.getElementById('scrollToBottom');
        const statusSelect = document.getElementById('statusSelect');
        const clientStatusSelector = document.getElementById('clientStatusSelector');
        const whatsappQrStatus = document.getElementById('whatsappQrStatus');
        const qrOverlay = document.getElementById('qrOverlay');
        const qrCode = document.getElementById('qrCode');
        const closeQR = document.getElementById('closeQR');
        const autoReportNotification = document.getElementById('autoReportNotification');
        const autoReportMessage = document.getElementById('autoReportMessage');


        // Check authentication on load
        if (!authToken) {
            window.location.href = '/';
        } else {
            loadCurrentUser();
        }

        // =============================================
        // ğŸ› ï¸ FRONTEND LOGIC - HELPER FUNCTIONS
        // =============================================

        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type} opacity-0`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        function showAutoReportNotification(data) {
            autoReportMessage.textContent = data.message;
            autoReportNotification.style.display = 'block';
            
            setTimeout(() => {
                autoReportNotification.style.display = 'none';
            }, 7000);
        }

        function updateWhatsAppStatus(data) {
            const isConnected = data.status === 'connected';
            whatsappStatus.textContent = data.message;
            isBotStopped = !data.aiBotRunning; // Keep bot status updated

            if (isConnected) {
                whatsappStatus.className = 'status-connected px-3 py-1 rounded-full text-sm font-bold';
                whatsappQrStatus.classList.add('hidden');
                qrOverlay.classList.add('hidden'); // Hide QR when connected
                updateBotStatusUI();
            } else {
                whatsappStatus.className = 'status-disconnected px-3 py-1 rounded-full text-sm font-bold';
                if (data.status === 'qr-ready') {
                    whatsappQrStatus.classList.remove('hidden');
                    // AUTO-SHOW QR CODE
                    if (qrOverlay.classList.contains('hidden')) {
                       // Only auto-fetch if QR overlay is not already open
                       setTimeout(() => fetchUserQRCode(), 1000);
                    }
                } else {
                    whatsappQrStatus.classList.add('hidden');
                    qrOverlay.classList.add('hidden');
                }
            }
        }
        
        function updateBotStatusUI() {
            if (isBotStopped) {
                botStatus.textContent = 'Ù…ØªÙˆÙ‚Ù';
                botStatus.className = 'bot-status-stopped px-3 py-1 rounded-full text-sm font-bold';
                stopBotBtn.innerHTML = '<i class="fas fa-play mr-2"></i>ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª';
                stopBotBtn.classList.remove('bot-status-stopped');
                stopBotBtn.classList.add('bg-primary', 'hover:bg-primary-dark');

            } else {
                botStatus.textContent = 'Ù†Ø´Ø·';
                botStatus.className = 'bot-status-running px-3 py-1 rounded-full text-sm font-bold';
                stopBotBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª';
                stopBotBtn.classList.add('bot-status-stopped');
                stopBotBtn.classList.remove('bg-primary', 'hover:bg-primary-dark');
            }
        }

        // =============================================
        // ğŸ› ï¸ FRONTEND LOGIC - DATA FETCHING & RENDERING
        // =============================================

        function loadCurrentUser() {
            fetch('/api/me', { 
                method: 'GET', 
                headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } 
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Initialize or update UI elements and start socket connection
                    updateUserInterface();
                    initializeSocket();
                } else {
                    window.location.href = '/';
                }
            })
            .catch(error => {
                console.error('Error loading user:', error);
                window.location.href = '/';
            });
        }
        
        function updateUserInterface() {
            const activeUser = isAdminViewingAs ? viewingAsUser : currentUser;
            if (!activeUser) return;
            
            currentUserName.textContent = activeUser.name;
            currentUserRole.textContent = activeUser.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ';
            
            // Admin features visibility
            userManagementSection.classList.toggle('hidden', activeUser.role !== 'admin' && !isAdminViewingAs);
            userSwitchBtn.classList.toggle('hidden', activeUser.role !== 'admin');
            
            // Viewing as another user logic
            const viewingAsBadge = document.getElementById('viewingAsBadge');
            if (isAdminViewingAs) {
                viewingAsBadge.classList.remove('hidden');
                document.getElementById('viewingAsName').textContent = viewingAsUser.name;
                document.getElementById('viewingAsRole').textContent = viewingAsUser.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ';
            } else {
                viewingAsBadge.classList.add('hidden');
            }

            // Load initial data for the current active user
            checkWhatsAppStatus();
            loadUsers();
            loadClients();
            loadPerformanceStats();
        }

        function checkWhatsAppStatus() {
            if (!authToken) return;
            fetch('/api/user-whatsapp-status', { 
                method: 'GET', 
                headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } 
            })
            .then(response => response.json())
            .then(data => {
                updateWhatsAppStatus(data);
            })
            .catch(error => {
                console.error('Error checking WhatsApp status:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨', 'error');
            });
        }

        function loadClients() {
            if (!authToken) return;
            const userId = isAdminViewingAs ? viewingAsUser.id : currentUser.id;
            fetch('/api/clients', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clients = data.clients.map(client => ({ 
                        ...client, 
                        unread: 0, 
                        id: client.phone 
                    })); // Use phone as ID
                    renderClientList();
                    updateClientsCount();
                    
                    // Re-select client if one was active
                    if (currentClient) {
                        const activeClient = clients.find(c => c.id === currentClient.id);
                        if (activeClient) {
                            selectClient(activeClient);
                        } else {
                            // Client no longer exists in list, clear chat
                            currentClient = null;
                            document.getElementById('chatHeader').classList.add('hidden');
                            document.getElementById('chatEmptyState').classList.remove('hidden');
                            messageInputArea.classList.add('hidden');
                        }
                    }
                } else {
                    showToast(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error loading clients:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', 'error');
            });
        }

        function renderClientList() {
            clientList.innerHTML = '';
            const filteredClients = clients.filter(client => {
                if (statusFilter === 'all') return true;
                return (client.status || 'no-reply') === statusFilter;
            });

            filteredClients.forEach(client => {
                const statusClass = `client-status-${client.status || 'no-reply'}`;
                const isActive = currentClient && currentClient.id === client.id;
                
                const clientElement = document.createElement('div');
                clientElement.className = `client-item flex items-center justify-between p-4 cursor-pointer hover:bg-gray-800 ${statusClass} ${isActive ? 'active' : ''}`;
                clientElement.dataset.phone = client.phone;
                
                const lastActivityDate = client.lastActivity ? new Date(client.lastActivity) : null;
                const timeString = lastActivityDate ? lastActivityDate.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';

                clientElement.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-user-circle text-2xl text-primary-light mr-3"></i>
                        <div>
                            <div class="font-bold text-sm">${client.name || 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯'}</div>
                            <div class="text-xs text-gray-400">
                                ${client.phone}
                                <span class="status-dot dot-${client.status || 'no-reply'} ml-2"></span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end">
                        <div class="text-xs text-gray-400 mb-1">
                            ${timeString}
                        </div>
                        ${client.unread > 0 ? `<span class="unread-badge px-2 py-0.5 rounded-full text-xs">${client.unread}</span>` : ''}
                    </div>
                `;
                
                clientElement.addEventListener('click', () => selectClient(client));
                clientList.appendChild(clientElement);
            });
            clientsListCount.textContent = filteredClients.length;
        }

        function selectClient(client) {
            if (currentClient && currentClient.id === client.id) {
                 // If already active, just clear unread and scroll
                const existingClient = clients.find(c => c.id === client.id);
                if (existingClient) {
                    existingClient.unread = 0;
                    renderClientList();
                }
                scrollChatToBottom();
                return;
            }
            
            currentClient = client;
            
            // Clear unread badge
            currentClient.unread = 0;
            
            // Update UI elements
            currentClientName.textContent = client.name || 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
            currentClientPhone.textContent = client.phone;
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('chatEmptyState').classList.add('hidden');
            messageInputArea.classList.remove('hidden');
            
            // Update status selector
            statusSelect.value = client.status || 'no-reply';
            clientStatusSelector.classList.remove('hidden');
            
            // Update client list UI
            renderClientList();
            
            // Load chat history
            loadMessages(client.phone);
        }

        function loadMessages(phone) {
            if (messages[phone]) {
                return renderMessages(messages[phone]);
            }
            
            fetch(`/api/client-messages/${phone}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messages[phone] = data.messages;
                    renderMessages(data.messages);
                } else {
                    showToast(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error loading messages:', error);
            });
        }

        function renderMessages(messagesToRender) {
            chatContainer.innerHTML = '';
            if (messagesToRender.length === 0) {
                chatContainer.innerHTML = `
                    <div class="text-center text-gray-400 mt-20">
                        <i class="fas fa-comments text-5xl mb-4 opacity-50"></i>
                        <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>
                    </div>
                `;
                return;
            }

            messagesToRender.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `chat-bubble ${message.fromMe ? 'sent' : 'received'}`;
                
                const messageTime = new Date(message.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="message-content">${message.message}</div>
                    <div class="chat-time">${messageTime}</div>
                `;
                chatContainer.appendChild(messageElement);
            });
            scrollChatToBottom();
        }

        function handleUserMessage(data) {
            const clientPhone = data.from;
            const message = {
                id: Date.now(),
                message: data.message,
                fromMe: data.fromMe,
                timestamp: data.timestamp
            };

            if (!messages[clientPhone]) {
                messages[clientPhone] = [];
            }
            messages[clientPhone].push(message);

            // Update clients list (add new client if unknown, update last message time)
            let client = clients.find(c => c.id === clientPhone);
            if (!client) {
                // New client from an incoming message
                client = { 
                    id: clientPhone, 
                    phone: clientPhone, 
                    name: data.fromMe ? (currentClient?.name || 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯') : 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯', 
                    status: 'no-reply', 
                    unread: 0 
                };
                clients.unshift(client); // Add to the top of the list
            }
            
            client.lastActivity = new Date(data.timestamp).toISOString();
            
            // Increment unread count if message is incoming AND not the current chat
            if (!data.fromMe && currentClient?.id !== clientPhone) {
                client.unread++;
                showToast(`âœ‰ï¸ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù†: ${client.name || clientPhone}`, 'warning');
            }
            
            // Ensure current client list is updated if client was new/updated
            clients.sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));


            // Re-render chat if it's the active client
            if (currentClient?.id === clientPhone) {
                renderMessages(messages[clientPhone]);
            }
            
            // Re-render client list
            renderClientList();
            updateClientsCount();
            loadPerformanceStats(); // Update stats in case of an AI reply
        }

        function updateClientsCount() {
            statClients.textContent = clients.length;
        }

        function scrollChatToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
            scrollToBottom.classList.remove('visible');
        }

        function loadPerformanceStats() {
            if (!authToken) return;
            fetch('/api/performance-stats', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    performanceStats = data.stats;
                    updatePerformanceStats(performanceStats);
                }
            })
            .catch(error => {
                console.error('Error loading performance stats:', error);
            });
        }

        function updatePerformanceStats(stats) {
            if (stats.messagesSent !== undefined) statMessages.textContent = stats.messagesSent;
            if (stats.aiRepliesSent !== undefined) statAIReplies.textContent = stats.aiRepliesSent;
            if (stats.clientsContacted !== undefined) statClients.textContent = stats.clientsContacted;
            if (stats.interestedClients !== undefined) statInterested.textContent = stats.interestedClients;
        }
        
        // =============================================
        // ğŸ› ï¸ FRONTEND LOGIC - WHATSAPP & QR
        // =============================================

        function showQRCode(qrDataUrl) {
            qrCode.innerHTML = `<img src="${qrDataUrl}" alt="WhatsApp QR Code" class="w-64 h-64 mx-auto p-4 bg-white rounded-lg" />`;
            qrOverlay.classList.remove('hidden');
            whatsappQrStatus.classList.add('hidden'); // Hide the status button while the overlay is open
        }

        function fetchUserQRCode() {
            if (!authToken) return;
            fetch('/api/user-whatsapp-qr', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.qrCode) {
                    showQRCode(data.qrCode);
                } else {
                    showToast('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ QR Code Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹', 'warning');
                }
            })
            .catch(error => {
                console.error('Error fetching QR code:', error);
                showToast('âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ QR Code', 'error');
            });
        }
        
        function toggleBotStatus() {
            const newStatus = !isBotStopped;
            fetch('/api/user-toggle-bot', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ stop: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isBotStopped = newStatus;
                    updateBotStatusUI();
                    showToast(`âœ… ${data.message}`, 'success');
                } else {
                    showToast(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¨ÙˆØª: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error toggling bot:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¨ÙˆØª', 'error');
            });
        }


        // =============================================
        // ğŸ› ï¸ FRONTEND LOGIC - USER MANAGEMENT
        // =============================================
        
        function loadUsers() {
            if (currentUser && currentUser.role === 'admin') {
                fetch('/api/users', { 
                    method: 'GET', 
                    headers: { 'Authorization': `Bearer ${authToken}` } 
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        users = data.users;
                        renderUsersList();
                    }
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                });
            }
        }

        function renderUsersList() {
            usersList.innerHTML = '';
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = `user-item flex items-center justify-between p-2 rounded-lg mb-2 cursor-pointer ${user.role === 'admin' ? 'role-admin' : 'role-standard'}`;
                
                const isActiveText = user.isActive ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
                const activeClass = user.isActive ? 'user-active' : 'user-inactive';

                userElement.innerHTML = `
                    <div>
                        <div class="font-bold text-sm">${user.name}</div>
                        <div class="text-xs text-gray-400">${user.username} - ${user.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ'}</div>
                        <div class="text-xs ${activeClass}">${isActiveText}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${currentUser.id !== user.id && currentUser.role === 'admin' ? `
                            <button class="switch-to-user-btn bg-gray-600 hover:bg-primary-dark text-white text-xs px-2 py-1 rounded transition-colors" data-user-id="${user.id}">
                                <i class="fas fa-eye mr-1"></i>Ø¹Ø±Ø¶
                            </button>
                        ` : ''}
                        ${currentUser.role === 'admin' ? `
                            <button class="toggle-user-status-btn bg-gray-600 hover:bg-yellow-600 text-white text-xs px-2 py-1 rounded transition-colors" data-user-id="${user.id}" data-is-active="${user.isActive}">
                                <i class="fas ${user.isActive ? 'fa-user-slash' : 'fa-user-check'} mr-1"></i>${user.isActive ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}
                            </button>
                        ` : ''}
                    </div>
                `;
                usersList.appendChild(userElement);
            });

            document.querySelectorAll('.switch-to-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.target.closest('button').dataset.userId;
                    switchToUser(userId);
                });
            });
            
            document.querySelectorAll('.toggle-user-status-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.target.closest('button').dataset.userId;
                    const isActive = e.target.closest('button').dataset.isActive === 'true';
                    updateUserStatus(userId, !isActive);
                });
            });
        }

        function switchToUser(userId) {
            const targetUser = users.find(u => u.id === userId);
            if (targetUser) {
                isAdminViewingAs = true;
                viewingAsUser = targetUser;
                userSwitchOverlay.classList.add('hidden');
                
                // Disconnect and reconnect socket for the new user context
                if (socket) socket.close();
                initializeSocket();
                
                updateUserInterface(); // This reloads data for the new user
                
                showToast(`ğŸ‘ï¸ ØªØ´Ø§Ù‡Ø¯ Ø§Ù„Ø¢Ù† ÙƒÙ€: ${targetUser.name}`, 'success');
            }
        }
        
        function updateUserStatus(userId, isActive) {
            if (!authToken) return;
            fetch('/api/update-user', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId, isActive })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`âœ… ØªÙ… ${isActive ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„'} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                    loadUsers(); // Reload user list
                } else {
                    showToast(`âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error updating user status:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            });
        }

        function clearUserForm() {
            newUserName.value = '';
            newUserUsername.value = '';
            newUserPassword.value = '';
            newUserRole.value = 'standard';
        }

        // =============================================
        // ğŸ› ï¸ FRONTEND LOGIC - EVENT LISTENERS
        // =============================================

        // --- Core Events ---
        logoutBtn.addEventListener('click', () => {
            fetch('/api/logout', { 
                method: 'POST', 
                headers: { 'Authorization': `Bearer ${authToken}` } 
            })
            .then(() => {
                localStorage.removeItem('token');
                localStorage.removeItem('currentUser');
                window.location.href = '/';
            })
            .catch(error => {
                console.error('Logout error:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('currentUser');
                window.location.href = '/';
            });
        });
        
        reconnectBtn.addEventListener('click', () => {
            showToast('ğŸ”„ Ø¬Ø§Ø±Ù Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...', 'warning');
            const activeUserId = isAdminViewingAs ? viewingAsUser.id : currentUser.id;
            
            // Re-initialize socket to trigger backend session re-initialization
            if (socket) socket.close();
            initializeSocket();
            // Also explicitly check status to update UI immediately
            checkWhatsAppStatus(); 
        });

        stopBotBtn.addEventListener('click', toggleBotStatus);
        
        whatsappQrStatus.addEventListener('click', fetchUserQRCode);
        closeQR.addEventListener('click', () => qrOverlay.classList.add('hidden'));

        // --- User Management Events ---
        userSwitchBtn.addEventListener('click', () => {
            userSwitchOverlay.classList.remove('hidden');
            currentViewingUser.textContent = isAdminViewingAs ? viewingAsUser.name : currentUser.name;
        });

        returnToAdmin.addEventListener('click', () => {
            isAdminViewingAs = false;
            viewingAsUser = null;
            userSwitchOverlay.classList.add('hidden');
            
            // Disconnect and reconnect socket back to admin context
            if (socket) socket.close();
            initializeSocket(); 
            
            updateUserInterface();
            showToast(`âœ… Ø¹Ø¯Øª Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ ÙƒÙ…Ø¯ÙŠØ±`, 'success');
        });

        closeUserSwitch.addEventListener('click', () => {
            userSwitchOverlay.classList.add('hidden');
        });
        
        // --- Client List & Chat Events ---
        statusSelect.addEventListener('change', (e) => {
            if (currentClient) {
                updateClientStatus(currentClient.phone, e.target.value);
            }
        });

        function setStatusFilter(status) {
            statusFilter = status;
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            renderClientList();
        }
        
        // Status Filter
        document.querySelectorAll('.status-filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const status = e.target.dataset.status;
                setStatusFilter(status);
            });
        });

        // Chat scroll detection
        chatContainer.addEventListener('scroll', () => {
            const scrollThreshold = 100;
            const isNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < scrollThreshold;
            
            if (isNearBottom) {
                scrollToBottom.classList.remove('visible');
            } else {
                scrollToBottom.classList.add('visible');
            }
        });

        scrollToBottom.addEventListener('click', () => {
            scrollChatToBottom();
        });


        // --- File Upload Events ---
        uploadBtn.addEventListener('click', () => {
            excelFile.click();
        });

        excelFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                uploadExcelFile(file);
            }
        });

        function uploadExcelFile(file) {
            const formData = new FormData();
            formData.append('excelFile', file);

            fetch('/api/upload-excel', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${authToken}` },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fileInfo.classList.remove('hidden');
                    fileInfo.innerHTML = `<i class="fas fa-file-excel text-primary-light mr-1"></i> ${file.name} (${data.count} Ø¹Ù…ÙŠÙ„)`;
                    showToast(`âœ… ØªÙ… Ø±ÙØ¹ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© ${data.count} Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                    loadClients();
                } else {
                    showToast(`âŒ ÙØ´Ù„ Ø±ÙØ¹ Ù…Ù„Ù Excel: ${data.error}`, 'error');
                }
                excelFile.value = ''; // Clear file input
            })
            .catch(error => {
                console.error('Error uploading file:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel', 'error');
                excelFile.value = '';
            });
        }
        
        // --- Message & Bulk Sending Events ---
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentClient) return;
            
            const activeUserId = isAdminViewingAs ? viewingAsUser.id : currentUser.id;

            socket.emit('send_message', { 
                to: currentClient.phone, 
                message: message 
            });
            
            // Optimistic update (message will be re-rendered via socket 'user_message_' event)
            messageInput.value = '';
        }

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendMessageBtn.addEventListener('click', sendMessage);

        sendBulkBtn.addEventListener('click', () => {
            startBulkSending(false);
        });

        retryBulkBtn.addEventListener('click', () => {
            startBulkSending(true);
        });

        function startBulkSending(isRetry) {
            const message = bulkMessage.value.trim();
            const delay = parseInt(sendDelay.value) || 5;

            if (!message) {
                return showToast('âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©', 'error');
            }
            
            let bulkClients = isRetry ? bulkCampaignLog : clients.filter(c => c.status !== 'not-interested');

            if (bulkClients.length === 0) {
                 return showToast('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„ÙŠÙ‡Ù…', 'error');
            }
            
            // Disable buttons and show progress
            sendBulkBtn.disabled = true;
            retryBulkBtn.disabled = true;
            bulkProgressInfo.classList.remove('hidden');
            bulkCampaignLog = []; // Clear log for new attempt

            fetch('/api/bulk-send', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    clients: bulkClients, 
                    message, 
                    delay 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`âœ… ${data.message}`, 'success', 5000);
                } else {
                    showToast(`âŒ ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Bulk send error:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©', 'error');
            });
        }

        // --- Reporting Events ---
        function exportReport() {
            if (!authToken) return;
            showToast('ğŸ”„ Ø¬Ø§Ø±Ù Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡...', 'warning');
            
            fetch('/api/export-report', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(response => {
                if (response.ok) {
                    response.blob().then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        
                        // Extract filename from Content-Disposition header
                        const contentDisposition = response.headers.get('Content-Disposition');
                        const filenameMatch = contentDisposition && contentDisposition.match(/filename="(.+?)"/);
                        const filename = filenameMatch ? filenameMatch[1] : `Performance_Report_${Date.now()}.xlsx`;
                        a.download = filename;
                        
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        showToast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    });
                } else {
                    response.json().then(data => {
                        showToast(`âŒ ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${data.error}`, 'error');
                    });
                }
            })
            .catch(error => {
                console.error('Error exporting report:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡', 'error');
            });
        }

        function sendReport() {
            if (!authToken) return;
            showToast('ğŸ”„ Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠØ±...', 'warning');
            fetch('/api/send-report-to-admin', {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json' 
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`âœ… ${data.message}`, 'success');
                } else {
                    showToast(`âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error sending report:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error');
            });
        }
        
        exportReportBtn.addEventListener('click', exportReport);
        sendReportBtn.addEventListener('click', sendReport);


        // =============================================
        // ğŸ› ï¸ FRONTEND LOGIC - SOCKET.IO CONNECTION
        // =============================================

        function initializeSocket() {
            const activeUser = isAdminViewingAs ? viewingAsUser : currentUser;
            if (!activeUser) return;
            
            const userId = activeUser.id;
            
            socket = io.connect(window.location.origin, {
                auth: { token: authToken } // Optional initial auth, we use 'authenticate' event
            });

            socket.on('connect', () => {
                console.log('Connected to server');
                
                // Explicitly send authentication for multi-user context
                if (authToken) {
                    socket.emit('authenticate', authToken);
                }
            });
            
            socket.on('authenticated', (data) => {
                console.log('Socket authenticated for userId:', data.userId);
                
                // Set up user-specific listeners
                const listenerId = data.userId; // The ID from the backend's authenticated event

                socket.on(`user_status_${listenerId}`, (data) => { 
                    console.log('ğŸ“¡ Received user status:', data); 
                    updateWhatsAppStatus(data); 
                });

                socket.on(`user_qr_${listenerId}`, (data) => { 
                    console.log('ğŸ“¡ Received QR code for user:', listenerId); 
                    if (data.qrCode) { 
                        showQRCode(data.qrCode); 
                    } 
                });

                socket.on(`user_bot_status_${listenerId}`, (data) => { 
                    console.log('ğŸ“¡ Received bot status:', data); 
                    isBotStopped = data.stopped; 
                    updateBotStatusUI(); 
                });

                socket.on(`user_message_${listenerId}`, (data) => { 
                    console.log('ğŸ“¡ Received user message:', data); 
                    handleUserMessage(data); 
                });
                
                socket.on('auto_report_notification', (data) => {
                    if (data.userId === listenerId) {
                        showAutoReportNotification(data);
                    }
                });
                
                socket.on('clients_updated', (data) => {
                    // Update client list when bulk operation finishes or status is changed by another user
                    loadClients();
                });
                
                socket.on('bulk_progress', (data) => {
                    bulkTotal.textContent = data.total || 0;
                    bulkSent.textContent = data.success || 0;
                    bulkFailed.textContent = data.fail || 0;
                    bulkProgressInfo.classList.remove('hidden');

                    if (data.type === 'end') {
                        showToast(`âœ… Ø§Ù†ØªÙ‡Ø§Ø¡ Ø­Ù…Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„. Ù†Ø¬Ø§Ø­: ${data.success}, ÙØ´Ù„: ${data.fail}`, 'success', 8000);
                        sendBulkBtn.disabled = false;
                        if (data.fail > 0) {
                            retryBulkBtn.classList.remove('hidden');
                            bulkCampaignLog = clients.filter(c => !c.phone || c.phone.length < 10); // Simple log for retries
                        } else {
                            retryBulkBtn.classList.add('hidden');
                        }
                    }
                });

                console.log(`âœ… User-specific listeners setup complete for user ${listenerId}`);
            });
            
            socket.on('disconnect', (reason) => { 
                console.log('Disconnected from server:', reason); 
                showToast('âŒ ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error'); 
            });
            
            socket.on('connect_error', (error) => { 
                console.error('Connection error:', error); 
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error'); 
            });
            
            socket.on('auth_error', (data) => {
                console.error('Socket Auth Error:', data.error);
                showToast(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${data.error}`, 'error', 5000);
                if (data.error.includes('ØºÙŠØ± ØµØ§Ù„Ø­') || data.error.includes('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')) {
                    localStorage.removeItem('token');
                    window.location.href = '/';
                }
            });
            
            socket.on('message_error', (data) => {
                 showToast(`âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù€ ${data.to}: ${data.error}`, 'error');
            });
        }
        
        // Load initial data
        // Initial check is done inside loadCurrentUser()
    </script>
</body>
</html>
