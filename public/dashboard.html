// FIXED AI Prompt Endpoint
app.put('/api/ai-prompt', authenticateToken, async (req, res) => {
    try {
        const { prompt } = req.body;
        
        console.log('ğŸ“ Received AI prompt save request:', {
            userId: req.user.id,
            promptLength: prompt?.length
        });
        
        // Add proper validation
        if (!prompt || typeof prompt !== 'string') {
            console.error('âŒ Invalid prompt data:', { prompt });
            return res.status(400).json({ 
                success: false, 
                error: 'Ø·Ù„Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©' 
            });
        }
        
        if (prompt.trim().length === 0) {
            return res.status(400).json({ 
                success: false, 
                error: 'Ø§Ù„Ù†Øµ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹' 
            });
        }
        
        // Check if user is admin
        if (req.user.role !== 'admin') {
            return res.status(403).json({ 
                success: false, 
                error: 'ØºÙŠØ± Ù…ØµØ±Ø­ - ØªØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±' 
            });
        }
        
        // Save to database or file system
        // Example: Save to a file
        const fs = require('fs').promises;
        const aiPromptPath = './data/ai-prompts/system-prompt.txt';
        
        try {
            // Ensure directory exists
            await fs.mkdir('./data/ai-prompts', { recursive: true });
            
            // Save the prompt
            await fs.writeFile(aiPromptPath, prompt, 'utf8');
            
            console.log('âœ… AI prompt saved successfully');
            
            res.json({ 
                success: true, 
                message: 'ØªÙ… Ø­ÙØ¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ù†Ø¬Ø§Ø­' 
            });
            
        } catch (fileError) {
            console.error('âŒ File system error:', fileError);
            res.status(500).json({ 
                success: false, 
                error: 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ Ø§Ù„Ù…Ù„Ù' 
            });
        }
        
    } catch (error) {
        console.error('âŒ Error saving AI prompt:', error);
        res.status(500).json({ 
            success: false, 
            error: 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù†Ø¸Ø§Ù…' 
        });
    }
});

// GET AI Prompt Endpoint
app.get('/api/ai-prompt', authenticateToken, async (req, res) => {
    try {
        // Check if user is admin
        if (req.user.role !== 'admin') {
            return res.status(403).json({ 
                success: false, 
                error: 'ØºÙŠØ± Ù…ØµØ±Ø­ - ØªØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±' 
            });
        }
        
        // Read from file system
        const fs = require('fs').promises;
        const aiPromptPath = './data/ai-prompts/system-prompt.txt';
        
        try {
            const prompt = await fs.readFile(aiPromptPath, 'utf8');
            
            res.json({ 
                success: true, 
                prompt: prompt 
            });
            
        } catch (fileError) {
            if (fileError.code === 'ENOENT') {
                // File doesn't exist, return empty prompt
                res.json({ 
                    success: true, 
                    prompt: '' 
                });
            } else {
                throw fileError;
            }
        }
        
    } catch (error) {
        console.error('âŒ Error loading AI prompt:', error);
        res.status(500).json({ 
            success: false, 
            error: 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…' 
        });
    }
});
